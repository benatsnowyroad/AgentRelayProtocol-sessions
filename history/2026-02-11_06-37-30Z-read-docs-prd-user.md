<!-- Generated by SpecStory, Markdown v2.1.0 -->

# 2026-02-11 06:37:30Z

<!-- Claude Code Session 1ccd22cc-8916-4f2c-b7a3-95b0199bce37 (2026-02-11 06:37:30Z) -->

_**User (2026-02-11 06:37:30Z)**_

Read docs/PRD-USER-ACCOUNTS.md and use task-master to parse it into implementation tasks. Focus on the 4-day migration plan. Create tasks with dependencies.

---

_**Agent (claude-opus-4-6 2026-02-11 06:37:32Z)**_





_**Agent (claude-opus-4-6 2026-02-11 06:37:33Z)**_

<think><details><summary>Thought Process</summary>
The user wants me to read the PRD document and then use task-master to parse it into implementation tasks. Let me start by reading the PRD file.
</details></think>

_**Agent (claude-opus-4-6 2026-02-11 06:37:34Z)**_

<tool-use data-tool-type="read" data-tool-name="Read"><details>
<summary>Tool use: **Read**</summary>
 `./docs/PRD-USER-ACCOUNTS.md`

```text
     1→# PRD: User Accounts & Channel Participation
     2→
     3→**Author:** computer_bot  
     4→**Date:** 2026-02-10  
     5→**Status:** Draft v1.1 (Gemini-reviewed)  
     6→**Stakeholders:** Ben, Shane, Andy  
     7→**Review Score:** 8/10
     8→
     9→---
    10→
    11→## Problem Statement
    12→
    13→ARP currently has channels with bot members, but no way for humans to:
    14→1. Create accounts and authenticate
    15→2. Join channels as themselves (not just "human_user")
    16→3. Participate in channel discussions alongside bots
    17→4. Manage their own bots and channel memberships
    18→
    19→## Goals
    20→
    21→1. **Authentication** — Secure login for human users
    22→2. **Identity** — Unique user profiles with display names
    23→3. **Participation** — Real-time chat in channels with bots
    24→4. **Ownership** — Users own channels they create and bots they register
    25→
    26→## Non-Goals (V1)
    27→
    28→- Multi-tenant organizations / teams
    29→- Role-based permissions beyond owner/member
    30→- User-to-user private messaging
    31→- Mobile app / native clients
    32→- Billing / paid tiers
    33→- Display name uniqueness (allow duplicates initially)
    34→- GitHub login (start with Google only, add later)
    35→
    36→---
    37→
    38→## User Stories
    39→
    40→### Authentication
    41→- **US-1:** As a visitor, I can sign up with email/password or social login (Google, GitHub)
    42→- **US-2:** As a user, I can log in and maintain a session across browser refreshes
    43→- **US-3:** As a user, I can log out and revoke my session
    44→
    45→### Profile
    46→- **US-4:** As a user, I can set my display name and avatar
    47→- **US-5:** As a user, I can view my account settings (email, connected accounts)
    48→
    49→### Channels
    50→- **US-6:** As a user, I can create a new channel and become its owner
    51→- **US-7:** As a user, I can join public channels or accept invites to private channels
    52→- **US-8:** As a user, I can leave channels I'm a member of
    53→- **US-9:** As a channel owner, I can add/remove bots and invite other users
    54→
    55→### Chat
    56→- **US-10:** As a user, I can send messages in channels I'm a member of
    57→- **US-11:** As a user, I can see real-time messages from bots and other humans
    58→- **US-12:** As a user, I can start a flow (structured discussion) with channel bots
    59→
    60→### Bots
    61→- **US-13:** As a user, I can register a bot I control (with API key)
    62→- **US-14:** As a user, I can add my bots to channels I own
    63→
    64→---
    65→
    66→## Technical Design
    67→
    68→### Authentication Provider
    69→
    70→**Recommendation: Auth0**
    71→
    72→Rationale:
    73→- Handles OAuth2/OIDC complexity (social logins, token refresh, MFA)
    74→- Free tier: 7,500 MAU (sufficient for MVP)
    75→- SDKs for React (frontend) and Go (backend verification)
    76→- Can migrate to self-hosted later if needed
    77→
    78→Alternatives considered:
    79→- **Clerk** — Great DX but pricier, less control
    80→- **Supabase Auth** — Would require Supabase migration
    81→- **Roll our own** — Too much work for MVP, security risk
    82→
    83→### Database Schema
    84→
    85→```sql
    86→-- Users table (synced from Auth0 on first login)
    87→CREATE TABLE users (
    88→    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    89→    auth0_id        VARCHAR(128) UNIQUE NOT NULL,  -- auth0|abc123
    90→    email           VARCHAR(255) UNIQUE NOT NULL,
    91→    display_name    VARCHAR(64),
    92→    avatar_url      TEXT,
    93→    created_at      TIMESTAMPTZ DEFAULT NOW(),
    94→    updated_at      TIMESTAMPTZ DEFAULT NOW(),
    95→    last_login_at   TIMESTAMPTZ
    96→);
    97→
    98→CREATE INDEX idx_users_auth0 ON users(auth0_id);
    99→CREATE INDEX idx_users_email ON users(email);
   100→
   101→-- Update channel_members to support user UUIDs
   102→-- (Currently uses string IDs like "human_user")
   103→ALTER TABLE channel_members 
   104→    ADD COLUMN user_id UUID REFERENCES users(id);
   105→
   106→-- Bot ownership
   107→ALTER TABLE agents
   108→    ADD COLUMN owner_id UUID REFERENCES users(id);
   109→```
   110→
   111→### API Changes
   112→
   113→#### New Endpoints
   114→
   115→```
   116→POST   /auth/callback      — Auth0 callback, creates/updates user, returns JWT
   117→POST   /auth/logout        — Revoke session
   118→GET    /auth/me            — Get current user profile
   119→PATCH  /auth/me            — Update display name, avatar
   120→
   121→GET    /users/:id          — Get public user profile
   122→```
   123→
   124→#### Modified Endpoints
   125→
   126→```
   127→POST   /channels           — Require auth, set createdBy to user.id
   128→POST   /channels/:id/members — Require auth, validate ownership for adding others
   129→POST   /channels/:id/messages — Require auth, set senderId to user.id
   130→POST   /agents/register    — Require auth, set owner_id to user.id
   131→```
   132→
   133→### Frontend Changes
   134→
   135→#### Auth Flow
   136→
   137→1. User clicks "Sign In" → redirect to Auth0
   138→2. Auth0 handles login (email/password or social)
   139→3. Auth0 redirects to `/auth/callback` with code
   140→4. Backend exchanges code for tokens, creates/updates user
   141→5. Backend returns JWT in httpOnly cookie
   142→6. Frontend stores user in React context
   143→
   144→#### New Components
   145→
   146→```
   147→/login              — Login page with Auth0 redirect
   148→/signup             — Signup page (or combined with login)
   149→/settings           — User profile settings
   150→/settings/bots      — Manage registered bots
   151→```
   152→
   153→#### Auth Context
   154→
   155→```typescript
   156→interface AuthContext {
   157→  user: User | null;
   158→  isLoading: boolean;
   159→  login: () => void;      // Redirect to Auth0
   160→  logout: () => void;     // Clear session
   161→}
   162→```
   163→
   164→### Session Management
   165→
   166→- **JWT in httpOnly cookie** — Secure, no XSS risk
   167→- **Token expiry:** 24 hours (configurable)
   168→- **Refresh:** Silent refresh via Auth0 refresh tokens
   169→- **Backend verification:** Validate JWT signature + expiry on each request
   170→
   171→### Real-time Identity
   172→
   173→WebSocket connections will include user identity:
   174→
   175→```typescript
   176→// On WS connect, send auth token
   177→ws.send(JSON.stringify({ 
   178→  type: 'auth', 
   179→  token: jwt 
   180→}));
   181→
   182→// Server validates and associates connection with user
   183→// Messages now include sender identity
   184→{
   185→  type: 'new_message',
   186→  message: {
   187→    senderId: 'user_abc123',
   188→    senderType: 'human',
   189→    senderName: 'Ben Collins',
   190→    senderAvatar: 'https://...',
   191→    content: '...'
   192→  }
   193→}
   194→```
   195→
   196→---
   197→
   198→## UI/UX
   199→
   200→### Login Page
   201→- Clean, minimal design
   202→- "Sign in with Google" button (primary)
   203→- "Sign in with GitHub" button (secondary)
   204→- Email/password form (tertiary)
   205→- Link to signup if no account
   206→
   207→### User Menu (Header)
   208→- Avatar dropdown in top-right
   209→- Display name
   210→- "Settings" link
   211→- "My Bots" link
   212→- "Logout" button
   213→
   214→### Channel Member List
   215→- Show user avatars + names
   216→- Online/offline indicator (via WebSocket presence)
   217→- Distinguish humans vs bots visually
   218→
   219→### Message Display
   220→- User avatar next to message
   221→- Display name with role badge (owner/member)
   222→- Timestamp
   223→
   224→---
   225→
   226→## Migration Plan
   227→
   228→### Phase 1: Backend Auth (Day 1)
   229→1. Set up Auth0 tenant and application
   230→2. Add users table and migration
   231→3. Implement `/auth/*` endpoints
   232→4. Add JWT middleware to protected routes
   233→
   234→### Phase 2: Frontend Auth (Day 2)
   235→1. Add Auth0 React SDK
   236→2. Create login/signup pages
   237→3. Add auth context provider
   238→4. Protect routes that require auth
   239→
   240→### Phase 3: Identity Integration (Day 3)
   241→1. Update channel creation to use real user IDs
   242→2. Update message posting to include user identity
   243→3. Update WebSocket to authenticate connections
   244→4. Update UI to show real user info
   245→
   246→### Phase 4: Polish (Day 4)
   247→1. User settings page
   248→2. Bot management page
   249→3. Invite system for private channels
   250→4. Testing and bug fixes
   251→
   252→---
   253→
   254→## Security Considerations
   255→
   256→### Authentication & Sessions
   257→1. **JWT secrets** — Store in environment, rotate periodically
   258→2. **CSRF protection** — SameSite cookies, verify origin
   259→3. **JWT revocation** — Maintain server-side blacklist for compromised tokens; short-lived access tokens (15 min) with refresh token rotation
   260→4. **Password policy** — Min 12 chars, require mixed case + number (enforced by Auth0)
   261→
   262→### Rate Limiting
   263→5. **Auth endpoints** — 10 requests/min per IP
   264→6. **Message posting** — 30 messages/min per user
   265→7. **Channel creation** — 5 channels/hour per user
   266→8. **API general** — 100 requests/min per user
   267→
   268→### Input Validation
   269→9. **Display names** — Max 64 chars, strip HTML, no URLs
   270→10. **Avatar URLs** — Allowlist domains only (gravatar.com, githubusercontent.com, googleusercontent.com) to prevent SSRF
   271→11. **Redirect URLs** — Strict allowlist validation, no open redirects
   272→
   273→### Bot Security
   274→12. **Bot API keys** — Never expose in frontend, bcrypt hash in DB
   275→13. **Bot-to-ARP auth** — Bots authenticate via signed requests (Ed25519); ARP never sends raw API keys
   276→14. **Bot ownership verification** — On registration, bot must respond to a challenge ping within 30s
   277→
   278→### Authorization
   279→15. **Action-level auth** — Every sensitive endpoint checks:
   280→    - User is authenticated (valid JWT)
   281→    - User has permission for action (owner/member role)
   282→    - Resource exists and user has access
   283→16. **Audit logging** — Log all auth events, channel changes, bot registrations with timestamp + IP + user ID
   284→
   285→---
   286→
   287→## Error Handling & User Feedback
   288→
   289→### Login Errors
   290→| Error | Message | Recovery |
   291→|-------|---------|----------|
   292→| Invalid credentials | "Email or password incorrect" | Show "Forgot password?" link |
   293→| Account locked | "Too many attempts. Try again in 15 min." | Show countdown timer |
   294→| OAuth failed | "Google sign-in failed. Try again." | Retry button + email fallback |
   295→| Email unverified | "Please verify your email to continue." | Resend verification link |
   296→
   297→### Channel Errors
   298→| Error | Message | Recovery |
   299→|-------|---------|----------|
   300→| Not a member | "You don't have access to this channel." | "Request access" button |
   301→| Channel full | "This channel has reached its member limit." | Contact owner |
   302→| Name taken | "A channel with this name already exists." | Suggest alternatives |
   303→
   304→### General Approach
   305→- Toast notifications for transient errors (network issues)
   306→- Inline validation for form fields
   307→- Full-page error states for critical failures (500s)
   308→- "Report issue" link on all error screens
   309→
   310→---
   311→
   312→## Data Retention & Privacy
   313→
   314→### Retention Policy
   315→| Data Type | Retention | Notes |
   316→|-----------|-----------|-------|
   317→| User profile | Until deletion | Includes email, display name, avatar |
   318→| Channel messages | Indefinite | Owned by channel, not user |
   319→| Auth sessions | 30 days inactive | Auto-cleanup via cron |
   320→| Audit logs | 90 days | Compliance requirement |
   321→
   322→### Account Deletion (GDPR)
   323→1. User requests deletion via Settings
   324→2. 7-day grace period (can cancel)
   325→3. After grace period:
   326→   - User record anonymized (email → `deleted-{uuid}@arp.local`)
   327→   - Display name → "Deleted User"
   328→   - Avatar removed
   329→   - Channel memberships removed
   330→   - Bot ownerships transferred to channel owner or deactivated
   331→   - Messages retained but author shown as "Deleted User"
   332→4. Confirmation email sent
   333→5. Audit log entry created (retained 90 days)
   334→
   335→### Data Export
   336→- User can request full data export (JSON)
   337→- Includes: profile, channel memberships, messages authored
   338→- Generated within 24 hours, download link emailed
   339→
   340→---
   341→
   342→## Success Metrics
   343→
   344→- Users can sign up and log in without errors
   345→- Users can create channels and chat with bots
   346→- WebSocket shows real user identity (not "human_user")
   347→- Session persists across browser refresh
   348→- < 500ms auth callback latency
   349→
   350→---
   351→
   352→## Open Questions
   353→
   354→1. **Public vs private channels** — Should all channels be private by default? Invite-only?
   355→2. ~~**Bot verification** — How do we verify a user actually controls a bot they register?~~ ✅ *Resolved: Challenge-response ping on registration*
   356→3. ~~**Display name uniqueness** — Required? Or allow duplicates?~~ ✅ *Resolved: Allow duplicates in V1*
   357→4. **Email verification** — Required before channel creation? *Recommendation: Yes, before creating channels but not for joining*
   358→5. ~~**Account deletion** — GDPR compliance, what happens to messages?~~ ✅ *Resolved: See Data Retention section*
   359→
   360→---
   361→
   362→## Appendix: Auth0 Setup Checklist
   363→
   364→### V1 Setup
   365→1. Create Auth0 tenant (e.g., `arp-dev`)
   366→2. Create Regular Web Application
   367→3. Configure callback URLs:
   368→   - `http://localhost:3000/auth/callback` (dev)
   369→   - `https://shimmering-healing-production.up.railway.app/auth/callback` (prod)
   370→4. Enable connections: **Google only** (add GitHub in V1.1)
   371→5. Enable email/password with verification required
   372→6. Set up API (audience) for backend verification
   373→7. Configure password policy: min 12 chars, mixed case + number
   374→8. Note: Client ID, Client Secret, Domain
   375→
   376→### Environment Variables Needed
   377→```bash
   378→AUTH0_DOMAIN=arp-dev.auth0.com
   379→AUTH0_CLIENT_ID=xxx
   380→AUTH0_CLIENT_SECRET=xxx
   381→AUTH0_AUDIENCE=https://api.arp.dev
   382→JWT_SECRET=<random-256-bit>
   383→```
   384→
   385→---
   386→
   387→*Ready for review. Ping with questions or suggested changes.*
   388→
```
</details></tool-use>

_**Agent (claude-opus-4-6 2026-02-11 06:37:34Z)**_

<tool-use data-tool-type="search" data-tool-name="Glob"><details>
<summary>Tool use: **Glob**</summary>
 pattern `.taskmaster/**/*`

```text
/Users/bencollins/Development/AgentRelayProtocol/.taskmaster/config.json
/Users/bencollins/Development/AgentRelayProtocol/.taskmaster/state.json
/Users/bencollins/Development/AgentRelayProtocol/.taskmaster/docs/prd-channels-flows.md
/Users/bencollins/Development/AgentRelayProtocol/.taskmaster/tasks/tasks.json
```
</details></tool-use>

_**Agent (claude-opus-4-6 2026-02-11 06:37:40Z)**_

<think><details><summary>Thought Process</summary>
Good, I can see the PRD and that taskmaster is already initialized. Let me parse the PRD into tasks using the taskmaster MCP tool. The PRD is at `docs/PRD-USER-ACCOUNTS.md` and the project root is `/Users/bencollins/Development/AgentRelayProtocol`.

The user wants me to focus on the 4-day migration plan and create tasks with dependencies. Let me use the parse_prd tool.
</details></think>

_**Agent (claude-opus-4-6 2026-02-11 06:37:41Z)**_

Taskmaster is already set up. Let me parse the PRD into tasks focused on the 4-day migration plan.

_**Agent (claude-opus-4-6 2026-02-11 06:37:42Z)**_

<tool-use data-tool-type="unknown" data-tool-name="mcp__taskmaster-ai__parse_prd"><details>
<summary>Tool use: **mcp__taskmaster-ai__parse_prd**</summary>

```text
MCP error -32000: Connection closed
```
</details></tool-use>
